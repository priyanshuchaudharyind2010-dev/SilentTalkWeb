<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Silent Talk</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial}
body{
  background:#0f0f0f;
  color:#fff;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.container{
  width:100%;
  max-width:420px;
  height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  padding:10px;
  background:#111;
  text-align:center;
}
#onlineStatus{
  font-size:13px;
  color:#00ff88;
}
#messages{
  flex:1;
  overflow-y:auto;
  padding:10px;
}
.msg{
  background:#222;
  padding:8px;
  margin-bottom:6px;
  border-radius:6px;
  font-size:14px;
}
.input-box{
  display:flex;
  padding:10px;
  background:#111;
}
input{
  flex:1;
  padding:10px;
  border:none;
  border-radius:5px;
  outline:none;
}
button{
  padding:10px 14px;
  margin-left:5px;
  border:none;
  border-radius:5px;
  background:#00ff88;
  cursor:pointer;
}
#login{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  justify-content:center;
  align-items:center;
}
.login-box{
  width:90%;
  max-width:300px;
  background:#111;
  padding:20px;
  border-radius:10px;
}
.login-box input{
  width:100%;
  margin-bottom:10px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <div class="login-box">
    <h2 style="text-align:center;margin-bottom:10px">Silent Talk</h2>
    <input id="name" placeholder="Your name">
    <input id="pass" type="password" placeholder="Password">
    <button style="width:100%" onclick="login()">Enter</button>
  </div>
</div>

<!-- CHAT -->
<div class="container" id="chat" style="display:none">
  <header>
    <h3>Private Chat</h3>
    <div id="onlineStatus">Connecting...</div>
  </header>

  <div id="messages"></div>

  <div class="input-box">
    <input id="msgInput" placeholder="Type message">
    <button onclick="sendMsg()">Send</button>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDMCOAamH396pZG2IILTwYLGRUKIgKXHQ",
  authDomain: "silenttalkweb-6835a.firebaseapp.com",
  databaseURL: "https://silenttalkweb-6835a-default-rtdb.firebaseio.com",
  projectId: "silenttalkweb-6835a"
});

const db = firebase.database();
let username = localStorage.getItem("username");

/* LOGIN CHECK */
window.onload = ()=>{
  if(username){
    document.getElementById("login").style.display="none";
    document.getElementById("chat").style.display="flex";
    setOnline();
  }
};

/* LOGIN */
function login(){
  const name = document.getElementById("name").value.trim();
  const pass = document.getElementById("pass").value;

  if(name===""){ alert("Enter name"); return; }
  if(pass!=="cutie123"){ alert("Wrong password"); return; }

  username = name;
  localStorage.setItem("username",username);
  document.getElementById("login").style.display="none";
  document.getElementById("chat").style.display="flex";
  setOnline();
}

/* ONLINE STATUS */
function setOnline(){
  const ref = db.ref("status/"+username);
  ref.set("online");
  ref.onDisconnect().set("offline");

  db.ref("status").on("value",snap=>{
    let c=0;
    snap.forEach(s=>{
      if(s.val()==="online") c++;
    });
    document.getElementById("onlineStatus").innerText="Online users: "+c;
  });
}

/* SEND MESSAGE */
function sendMsg(){
  const text = msgInput.value.trim();
  if(text==="") return;

  db.ref("messages").push({
    user:username,
    text:text,
    time:Date.now()
  });
  msgInput.value="";
}

/* RECEIVE MESSAGE */
db.ref("messages").limitToLast(50).on("child_added",snap=>{
  const d = snap.val();
  const div = document.createElement("div");
  div.className="msg";
  div.innerText = d.user + ": " + d.text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;

  if(document.hidden && Notification.permission==="granted"){
    new Notification("New message",{body:d.user+": "+d.text});
  }
});

/* NOTIFICATION PERMISSION */
if("Notification" in window){
  Notification.requestPermission();
}
</script>

</body>
</html>